DROP TABLE IF EXISTS user_role;
DROP TABLE IF EXISTS user;
DROP TABLE IF EXISTS unit;
DROP TABLE IF EXISTS role;
DROP TABLE IF EXISTS user_role;
CREATE TABLE user
(
    id      INT AUTO_INCREMENT PRIMARY KEY,
    version INT          NOT NULL,
    name    VARCHAR(250) NOT NULL
);

INSERT INTO user (version, name)
VALUES (1, 'Alice'),
       (2, 'Bob'),
       (3, 'Eve');


CREATE TABLE unit
(
    id      BIGINT GENERATED BY DEFAULT AS IDENTITY (START
        WITH 11) PRIMARY KEY,
    version INT          NOT NULL,
    name    VARCHAR(250) NOT NULL
);


INSERT INTO unit (version, name)
VALUES (2, 'Kreftregisteret'),
       (1, 'Akershus universitetssykehus HF'),
       (2, 'SÃ¸rlandet sykehus HF'),
       (2, 'Vestre Viken HF');

CREATE TABLE role
(
    id      BIGINT GENERATED BY DEFAULT AS IDENTITY (START
            WITH 101) PRIMARY KEY,
    version INT          NOT NULL,
    name    VARCHAR(250) NOT NULL
);


INSERT INTO role (version, name)
VALUES (1, 'User administration'),
       (2, 'Endoscopist administration'),
       (1, 'Report colonoscopy capacity'),
       (2, 'Send invitations'),
       (1, 'View statistics');

CREATE TABLE user_role
(
    id      BIGINT GENERATED BY DEFAULT AS IDENTITY (START
        WITH 1001) ,
    version INT          NOT NULL,
    userId INT           NOT NULL,
    unitId BIGINT        NOT NULL,
    roleId BIGINT        NOT NULL,
    validFrom TIMESTAMP WITH TIME ZONE,
    validTo TIMESTAMP WITH TIME ZONE,
    foreign key (userId) references user(id),
    foreign key (unitId) references unit(id),
    foreign key (roleId) references role(id),
    PRIMARY KEY(userId, unitId, roleId)
);
create INDEX unique_user_role on user_role(id,userId,unitId,roleId);

INSERT INTO user_role (version,userId,unitId,roleId,validFrom,validTo)
VALUES (1,1,11,101, '2019-01-02 00:00:00','2019-12-31 23:59:59'),
       (2,1,11,104, '2019-01-02 00:00:00','2019-12-31 23:59:59'),
       (1,1,11,105, '2019-06-11 00:00:00','2019-12-31 23:59:59'),
       (2,2,12,101, '2020-01-28 00:00:00',null),
       (1,2,12,105, '2020-01-28 00:00:00',null),
       (1,2,14,101, '2019-01-02 00:00:00',null),
       (1,2,14,102, '2019-01-02 00:00:00',null),
       (1,1,11,102, '2020-02-01 07:00:00',null),
       (1,1,12,104, '2020-02-01 07:00:00',null);


